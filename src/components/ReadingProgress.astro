---
interface Props {
  readingTime: string
}

const { readingTime } = Astro.props
---

<div id="reading-progress-container" class="fixed top-[57px] left-0 right-0 z-40 pointer-events-none opacity-0 transition-opacity duration-300">
  <div class="h-10 bg-background/90 backdrop-blur-md border-b pointer-events-auto">
    <div class="h-full max-w-5xl mx-auto px-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <span id="progress-percent" class="text-sm font-mono font-medium">0%</span>
        <div class="h-1.5 w-32 sm:w-48 bg-muted rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-foreground rounded-full transition-all duration-150" style="width: 0%"></div>
        </div>
      </div>
      <div class="flex items-center gap-4 text-sm text-muted-foreground">
        <span id="time-remaining" class="hidden sm:inline">{readingTime}</span>
        <span id="word-count" class="hidden sm:inline"></span>
      </div>
    </div>
  </div>
</div>

<div id="rabbit-scene" class="fixed bottom-0 left-0 right-0 z-30 pointer-events-none h-24 overflow-hidden">
  <!-- Ground with grass -->
  <div class="absolute bottom-0 left-0 right-0 h-3 bg-foreground/5"></div>
  
  <svg id="grass-svg" class="absolute bottom-0 left-0 right-0 h-8" preserveAspectRatio="none">
    <defs>
      <pattern id="grass-pattern" width="12" height="16" patternUnits="userSpaceOnUse">
        <path d="M2 16 Q2 10 4 6 Q2 10 2 16" fill="none" stroke="currentColor" stroke-width="1.5" class="text-foreground/15"/>
        <path d="M6 16 Q6 8 8 4 Q6 8 6 16" fill="none" stroke="currentColor" stroke-width="1.5" class="text-foreground/15"/>
        <path d="M10 16 Q10 11 12 7 Q10 11 10 16" fill="none" stroke="currentColor" stroke-width="1.5" class="text-foreground/15"/>
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grass-pattern)" />
  </svg>

  <!-- Running Rabbit with realistic animation -->
  <div id="rabbit" class="absolute bottom-3" style="left: -80px;">
    <svg id="rabbit-svg" width="70" height="55" viewBox="0 0 70 55" class="rabbit-idle">
      <!-- Shadow -->
      <ellipse id="rabbit-shadow" cx="35" cy="52" rx="18" ry="3" fill="currentColor" class="text-foreground/10"/>
      
      <!-- Back leg (behind body) -->
      <g id="back-leg-back" class="origin-[20px_35px]">
        <ellipse cx="18" cy="42" rx="6" ry="4" fill="currentColor" class="text-foreground/60"/>
        <ellipse cx="14" cy="48" rx="5" ry="3" fill="currentColor" class="text-foreground/70"/>
      </g>
      
      <!-- Front leg (behind body) -->
      <g id="front-leg-back" class="origin-[45px_35px]">
        <ellipse cx="42" cy="42" rx="4" ry="6" fill="currentColor" class="text-foreground/60"/>
        <ellipse cx="42" cy="50" rx="4" ry="2.5" fill="currentColor" class="text-foreground/70"/>
      </g>
      
      <!-- Tail -->
      <circle id="rabbit-tail" cx="8" cy="32" r="5" fill="currentColor" class="text-foreground/90"/>
      
      <!-- Body -->
      <ellipse id="rabbit-body" cx="28" cy="32" rx="20" ry="12" fill="currentColor" class="text-foreground/85"/>
      
      <!-- Back leg (front) -->
      <g id="back-leg-front" class="origin-[25px_35px]">
        <ellipse cx="23" cy="42" rx="6" ry="4" fill="currentColor" class="text-foreground/75"/>
        <ellipse cx="19" cy="48" rx="5" ry="3" fill="currentColor" class="text-foreground/85"/>
      </g>
      
      <!-- Front leg (front) -->
      <g id="front-leg-front" class="origin-[48px_35px]">
        <ellipse cx="48" cy="42" rx="4" ry="6" fill="currentColor" class="text-foreground/75"/>
        <ellipse cx="48" cy="50" rx="4" ry="2.5" fill="currentColor" class="text-foreground/85"/>
      </g>
      
      <!-- Head -->
      <g id="rabbit-head">
        <ellipse cx="48" cy="24" rx="12" ry="10" fill="currentColor" class="text-foreground/85"/>
        
        <!-- Ears -->
        <g id="rabbit-ear-left" class="origin-[42px_18px]">
          <ellipse cx="40" cy="8" rx="4" ry="12" fill="currentColor" class="text-foreground/85"/>
          <ellipse cx="40" cy="9" rx="2" ry="8" fill="currentColor" class="text-background/30"/>
        </g>
        <g id="rabbit-ear-right" class="origin-[52px_18px]">
          <ellipse cx="50" cy="6" rx="4" ry="13" fill="currentColor" class="text-foreground/85"/>
          <ellipse cx="50" cy="7" rx="2" ry="9" fill="currentColor" class="text-background/30"/>
        </g>
        
        <!-- Face details -->
        <circle cx="52" cy="22" r="2" fill="currentColor" class="text-foreground"/>
        <ellipse cx="56" cy="26" rx="3" ry="2" fill="currentColor" class="text-foreground/40"/>
        <circle cx="58" cy="25" r="1" fill="currentColor" class="text-background/60"/>
        
        <!-- Whiskers -->
        <line x1="55" y1="26" x2="65" y2="24" stroke="currentColor" stroke-width="0.5" class="text-foreground/30"/>
        <line x1="55" y1="27" x2="65" y2="27" stroke="currentColor" stroke-width="0.5" class="text-foreground/30"/>
        <line x1="55" y1="28" x2="65" y2="30" stroke="currentColor" stroke-width="0.5" class="text-foreground/30"/>
      </g>
    </svg>
  </div>

  <!-- Dust particles when running -->
  <div id="dust-container" class="absolute bottom-3 pointer-events-none"></div>

  <!-- Well at the end -->
  <div id="well" class="absolute bottom-0 right-8 opacity-0 transition-opacity duration-500" style="transform: translateY(20px);">
    <svg width="60" height="55" viewBox="0 0 60 55">
      <ellipse cx="30" cy="50" rx="28" ry="5" fill="currentColor" class="text-foreground/20"/>
      <rect x="5" y="25" width="50" height="25" fill="currentColor" class="text-foreground/15" rx="2"/>
      <ellipse cx="30" cy="25" rx="25" ry="8" fill="currentColor" class="text-foreground/25"/>
      <ellipse cx="30" cy="25" rx="18" ry="5" fill="currentColor" class="text-background"/>
      <rect x="28" y="5" width="4" height="20" fill="currentColor" class="text-foreground/30"/>
      <rect x="15" y="2" width="30" height="4" fill="currentColor" class="text-foreground/30" rx="1"/>
    </svg>
  </div>
</div>

<style>
  /* Realistic running cycle - 8 phases */
  @keyframes rabbit-run {
    0%, 100% { transform: translateY(0); }
    12.5% { transform: translateY(-4px); }
    25% { transform: translateY(-8px); }
    37.5% { transform: translateY(-6px); }
    50% { transform: translateY(0); }
    62.5% { transform: translateY(-3px); }
    75% { transform: translateY(-6px); }
    87.5% { transform: translateY(-4px); }
  }
  
  /* Back legs animation - powerful push */
  @keyframes back-leg-run {
    0% { transform: rotate(-30deg) translateX(5px); }
    25% { transform: rotate(40deg) translateX(-10px); }
    50% { transform: rotate(20deg) translateX(-5px); }
    75% { transform: rotate(-20deg) translateX(8px); }
    100% { transform: rotate(-30deg) translateX(5px); }
  }
  
  /* Front legs animation - reaching forward */
  @keyframes front-leg-run {
    0% { transform: rotate(30deg) translateX(-8px); }
    25% { transform: rotate(-20deg) translateX(5px); }
    50% { transform: rotate(-35deg) translateX(10px); }
    75% { transform: rotate(15deg) translateX(-3px); }
    100% { transform: rotate(30deg) translateX(-8px); }
  }
  
  /* Ear bounce while running */
  @keyframes ear-bounce-left {
    0%, 100% { transform: rotate(-5deg); }
    25% { transform: rotate(-15deg); }
    50% { transform: rotate(5deg); }
    75% { transform: rotate(-10deg); }
  }
  
  @keyframes ear-bounce-right {
    0%, 100% { transform: rotate(5deg); }
    25% { transform: rotate(15deg); }
    50% { transform: rotate(-5deg); }
    75% { transform: rotate(10deg); }
  }
  
  /* Body stretch while running */
  @keyframes body-stretch {
    0%, 100% { transform: scaleX(1) scaleY(1); }
    25% { transform: scaleX(1.08) scaleY(0.94); }
    50% { transform: scaleX(0.95) scaleY(1.05); }
    75% { transform: scaleX(1.05) scaleY(0.96); }
  }
  
  /* Tail wiggle */
  @keyframes tail-wiggle {
    0%, 100% { transform: translateX(0) translateY(0); }
    25% { transform: translateX(-2px) translateY(-1px); }
    50% { transform: translateX(1px) translateY(1px); }
    75% { transform: translateX(-1px) translateY(-1px); }
  }
  
  /* Head bob */
  @keyframes head-bob {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-2px) rotate(-2deg); }
    50% { transform: translateY(1px) rotate(1deg); }
    75% { transform: translateY(-1px) rotate(-1deg); }
  }
  
  /* Shadow pulse */
  @keyframes shadow-pulse {
    0%, 100% { transform: scaleX(1) scaleY(1); opacity: 0.1; }
    25% { transform: scaleX(0.7) scaleY(0.8); opacity: 0.15; }
    50% { transform: scaleX(1.1) scaleY(1.1); opacity: 0.08; }
    75% { transform: scaleX(0.8) scaleY(0.9); opacity: 0.12; }
  }
  
  /* Idle breathing animation */
  @keyframes idle-breathe {
    0%, 100% { transform: scaleY(1); }
    50% { transform: scaleY(1.03); }
  }
  
  @keyframes idle-ear-twitch {
    0%, 90%, 100% { transform: rotate(0deg); }
    93% { transform: rotate(-8deg); }
    96% { transform: rotate(5deg); }
  }
  
  /* Apply running animations */
  #rabbit.running {
    animation: rabbit-run 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #back-leg-back,
  #rabbit.running #back-leg-front {
    animation: back-leg-run 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #front-leg-back,
  #rabbit.running #front-leg-front {
    animation: front-leg-run 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #front-leg-back,
  #rabbit.running #back-leg-back {
    animation-delay: 0.045s;
  }
  
  #rabbit.running #rabbit-ear-left {
    animation: ear-bounce-left 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #rabbit-ear-right {
    animation: ear-bounce-right 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #rabbit-body {
    animation: body-stretch 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #rabbit-tail {
    animation: tail-wiggle 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #rabbit-head {
    animation: head-bob 0.18s ease-in-out infinite;
  }
  
  #rabbit.running #rabbit-shadow {
    animation: shadow-pulse 0.18s ease-in-out infinite;
  }
  
  /* Idle state */
  #rabbit.idle #rabbit-body {
    animation: idle-breathe 2s ease-in-out infinite;
  }
  
  #rabbit.idle #rabbit-ear-right {
    animation: idle-ear-twitch 4s ease-in-out infinite;
  }
  
  /* Falling animation */
  #rabbit.falling {
    animation: none !important;
    transition: all 0.6s cubic-bezier(0.55, 0, 1, 0.45);
  }
  
  #rabbit.falling * {
    animation: none !important;
  }
  
  /* Dust particle */
  @keyframes dust-float {
    0% { 
      transform: translateY(0) translateX(0) scale(1); 
      opacity: 0.6; 
    }
    100% { 
      transform: translateY(-15px) translateX(-20px) scale(0.3); 
      opacity: 0; 
    }
  }
  
  .dust-particle {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    animation: dust-float 0.4s ease-out forwards;
    pointer-events: none;
  }
  
  @keyframes splash {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(2.5); opacity: 0; }
  }
  
  .splash-effect {
    animation: splash 0.6s ease-out forwards;
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const container = document.getElementById('reading-progress-container')
    const progressBar = document.getElementById('progress-bar')
    const progressPercent = document.getElementById('progress-percent')
    const timeRemaining = document.getElementById('time-remaining')
    const wordCount = document.getElementById('word-count')
    const rabbit = document.getElementById('rabbit')
    const well = document.getElementById('well')
    const rabbitScene = document.getElementById('rabbit-scene')
    const dustContainer = document.getElementById('dust-container')
    
    if (!container || !progressBar || !rabbit) return
    
    const article = document.querySelector('article.prose')
    if (!article) return
    
    const words = article.textContent?.split(/\s+/).length || 0
    if (wordCount) wordCount.textContent = `${words.toLocaleString()} words`
    
    const wordsPerMinute = 200
    const totalMinutes = Math.ceil(words / wordsPerMinute)
    
    let lastProgress = 0
    let lastRabbitX = -80
    let rabbitFallen = false
    let isRunning = false
    let dustTimer: number | null = null
    let idleTimer: number | null = null
    
    // Create dust particle
    const createDust = (x: number) => {
      if (!dustContainer || rabbitFallen) return
      
      const dust = document.createElement('div')
      dust.className = 'dust-particle text-foreground/30'
      dust.style.left = `${x + 15}px`
      dust.style.bottom = '0px'
      dustContainer.appendChild(dust)
      
      setTimeout(() => dust.remove(), 400)
    }
    
    // Start running animation with dust
    const startRunning = () => {
      if (isRunning || rabbitFallen) return
      isRunning = true
      rabbit.classList.remove('idle')
      rabbit.classList.add('running')
      
      // Clear any idle timer
      if (idleTimer) {
        clearTimeout(idleTimer)
        idleTimer = null
      }
    }
    
    // Stop running and go to idle
    const stopRunning = () => {
      if (!isRunning || rabbitFallen) return
      
      // Delay before going idle (coast a bit)
      idleTimer = window.setTimeout(() => {
        isRunning = false
        rabbit.classList.remove('running')
        rabbit.classList.add('idle')
      }, 300)
    }
    
    const updateProgress = () => {
      const articleRect = article.getBoundingClientRect()
      const articleTop = articleRect.top + window.scrollY
      const articleHeight = articleRect.height
      const windowHeight = window.innerHeight
      const scrolled = window.scrollY - articleTop + windowHeight * 0.3
      
      let progress = Math.max(0, Math.min(100, (scrolled / articleHeight) * 100))
      
      if (window.scrollY > 100) {
        container.classList.remove('opacity-0')
        container.classList.add('opacity-100')
        rabbitScene?.classList.remove('opacity-0')
      } else {
        container.classList.add('opacity-0')
        container.classList.remove('opacity-100')
      }
      
      progressBar.style.width = `${progress}%`
      if (progressPercent) progressPercent.textContent = `${Math.round(progress)}%`
      
      const remainingPercent = (100 - progress) / 100
      const remainingMinutes = Math.ceil(totalMinutes * remainingPercent)
      if (timeRemaining) {
        timeRemaining.textContent = remainingMinutes <= 1 ? '< 1 min left' : `${remainingMinutes} min left`
      }
      
      const viewportWidth = window.innerWidth
      const wellPosition = viewportWidth - 90
      const rabbitTargetX = (progress / 100) * (wellPosition + 30) - 80
      
      if (!rabbitFallen) {
        // Smooth rabbit movement
        const deltaX = rabbitTargetX - lastRabbitX
        
        if (Math.abs(deltaX) > 2) {
          // Rabbit is moving - start running
          startRunning()
          
          // Create dust particles while running
          if (isRunning && Math.abs(deltaX) > 5) {
            createDust(rabbitTargetX)
          }
        } else {
          // Rabbit stopped - go to idle
          stopRunning()
        }
        
        // Update position with smooth transition
        rabbit.style.left = `${rabbitTargetX}px`
        rabbit.style.transition = 'left 0.15s ease-out'
        lastRabbitX = rabbitTargetX
      }
      
      // Show well near the end
      if (progress >= 80 && well) {
        well.style.opacity = '1'
        well.style.transform = 'translateY(0)'
      }
      
      // Rabbit falls into well at the end
      if (progress >= 96 && !rabbitFallen) {
        rabbitFallen = true
        stopRunning()
        rabbit.classList.remove('running', 'idle')
        rabbit.classList.add('falling')
        
        // Jump into well animation
        setTimeout(() => {
          rabbit.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 1, 1)'
          rabbit.style.left = `${wellPosition - 15}px`
          rabbit.style.transform = 'translateY(-20px) rotate(-10deg)'
        }, 50)
        
        setTimeout(() => {
          rabbit.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 1, 1)'
          rabbit.style.transform = 'translateY(40px) rotate(15deg) scale(0.4)'
          rabbit.style.opacity = '0'
        }, 350)
        
        // Splash effect
        setTimeout(() => {
          if (!rabbitScene) return
          
          // Multiple splash particles
          for (let i = 0; i < 5; i++) {
            const splash = document.createElement('div')
            splash.className = 'absolute rounded-full bg-foreground/25 splash-effect'
            splash.style.width = `${8 + Math.random() * 8}px`
            splash.style.height = `${4 + Math.random() * 4}px`
            splash.style.right = `${30 + Math.random() * 20}px`
            splash.style.bottom = `${20 + Math.random() * 10}px`
            splash.style.animationDelay = `${i * 0.05}s`
            rabbitScene.appendChild(splash)
            
            setTimeout(() => splash.remove(), 700)
          }
        }, 550)
      }
      
      lastProgress = progress
    }
    
    // Initialize rabbit in idle state
    rabbit.classList.add('idle')
    
    let ticking = false
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateProgress()
          ticking = false
        })
        ticking = true
      }
    })
    
    updateProgress()
  })
</script>
